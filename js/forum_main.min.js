document.addEventListener("DOMContentLoaded",(function(){async function e(e){try{const t=await fetch("core/api.php",{method:"POST",body:e}),n=await t.text();try{return JSON.parse(n)}catch(e){throw new Error("Invalid JSON response: "+n)}}catch(e){throw e}}window.quill=new Quill("#editor",{theme:"snow",modules:{syntax:!0,toolbar:{container:[[{header:[1,2,3,!1]}],["blockquote","link"],["bold","italic","underline","strike"],["image","video","code-block"],[{list:"ordered"},{list:"bullet"},{font:[]}],[{align:[]},{color:[]}]],handlers:{image:function(){const e=this.quill.getSelection(),t=prompt("Введите ссылку на картинку.");t&&""!=t&&this.quill.insertEmbed(e?e.index:0,"image",t,Quill.sources.USER)}}}}});const t=document.querySelectorAll(".collapse");t.forEach((e=>{e.addEventListener("show.bs.collapse",(function(){t.forEach((t=>{if(t!==e&&t.classList.contains("show")){const e=bootstrap.Collapse.getInstance(t);e?e.hide():new bootstrap.Collapse(t,{toggle:!1}).hide()}}))}))}));const n=document.getElementById("action"),a=document.getElementById("icon"),i=document.getElementById("cat_fsub"),o=document.getElementById("createBtn");function d(){const e=n&&"new_subcat"===n.value;a&&(a.style.display=e?"":"none"),i&&(i.style.display=e?"":"none")}n&&(n.addEventListener("change",d),d()),o&&o.addEventListener("click",(async()=>{const t=n?n.value:"new_cat",o=document.getElementById("name").value.trim(),d=document.getElementById("prior").value.trim(),l=a?a.value.trim():"",c=i?i.value:"",r=new FormData;r.append("forum_admin",t),r.append("name",o),r.append("prior",d),"new_subcat"===t&&(r.append("icon",l),r.append("cat_id",c));try{const t=await e(r);t.error?alert(t.error):location.reload()}catch(e){alert("Ошибка: "+e.message)}})),document.querySelectorAll(".edit-btn").forEach((t=>{t.addEventListener("click",(async n=>{const a=t.id.split("-")[1],i=document.getElementById("action_edit-"+a),o=document.getElementById("cat_id-"+a),d=document.getElementById("edit_name-"+a),l=document.getElementById("edit_prior-"+a),c=document.getElementById("edit_icon-"+a),r=i?i.value:"edit_cat",s=new FormData;"edit_cat"===r?(s.append("forum_admin","edit_cat"),s.append("id",a),s.append("name",d.value.trim()),s.append("prior",l.value.trim())):(s.append("forum_admin","edit_subcat"),s.append("id",o?o.value:""),s.append("name",d.value.trim()),s.append("prior",l.value.trim()),s.append("cat_id",a),s.append("icon",c?c.value.trim():""));try{const t=await e(s);t.error?alert(t.error):location.reload()}catch(e){alert("Сетевая ошибка: "+e.message)}}))})),document.querySelectorAll(".edit-action").forEach((e=>{const t=e.id.split("-")[1],n=document.getElementById("cat_id-"+t),a=document.getElementById("edit_name-"+t),i=document.getElementById("edit_prior-"+t),o=document.getElementById("edit_icon-"+t);function d(){if(!e)return;const t="edit_subcat"===e.value;o&&(o.style.display=t?"":"none"),n&&(n.style.display=t?"":"none"),t&&n&&(a.value=n.options[n.selectedIndex].text,i.value=n.options[n.selectedIndex].dataset.prior||"",o.value=n.options[n.selectedIndex].dataset.icon||"")}e.addEventListener("change",d),d(),n&&n.addEventListener("change",(()=>{a&&i&&o&&(a.value=n.options[n.selectedIndex].text,i.value=n.options[n.selectedIndex].dataset.prior||"",o.value=n.options[n.selectedIndex].dataset.icon||"")}))})),document.querySelectorAll(".rm-btn").forEach((t=>{t.addEventListener("click",(async()=>{const n=t.id.split("-")[1],a=document.getElementById("action_edit-"+n),i=document.getElementById("cat_id-"+n),o=a?a.value:"edit_cat";if(!confirm("Удалить выбранный элемент?"))return;const d=new FormData;"edit_cat"===o?(d.append("forum_admin","delete_cat"),d.append("id",n)):(d.append("forum_admin","delete_subcat"),d.append("id",i?i.value:""));try{const t=await e(d);t.error?alert(t.error):location.reload()}catch(e){alert("Ошибка: "+e.message)}}))}));let l=null;document.querySelectorAll(".newpost-btn").forEach((e=>{e.addEventListener("click",(()=>{l=e.id.split("-")[1];const t=e.dataset.name||e.closest('[id^="subcat-"]')?.querySelector(".subcat-name")?.textContent||"подкатегории";document.getElementById("modallbl").innerText="Новый тред в «"+t+"»";document.getElementById("iinpttl").value="",window.quill&&(window.quill.root.innerHTML="")}))}));const c=document.getElementById("publish");function r(e,t,n,a){const i=(e=Math.abs(e)%100)%10;return e>10&&e<20?a:i>1&&i<5?n:1==i?t:a}c&&c.addEventListener("click",(async()=>{if(!l)return void alert("Не выбрана подкатегория");const t=document.getElementById("iinpttl").value.trim(),n=quill.getContents(),a=JSON.stringify(n),i=new FormData;i.append("forum","new_thread"),i.append("subcat_id",l),i.append("topic",t),i.append("content",a);try{const t=await e(i);t.error?alert(t.error||"Ошибка при создании треда."):location.reload()}catch(e){alert("Сетевая ошибка: "+e.message)}})),window.get_threads=async function(t,n=1){const a=document.getElementById("threadList-"+t),i=document.getElementById("threadPag-"+t);if(!a||!i)return;const o=new FormData;o.append("forum","get_threads"),o.append("subcat_id",t),o.append("page",n);try{const n=await e(o);if(n.error)return void alert(n.error);a.innerHTML="";for(const e of n.data)a.innerHTML+=`\n                <div class="d-flex align-items-center mb-2" style="margin-left:1rem;">\n                    <a href="/profile.php?id=${e.author_steamid}" title="${e.author_name}" class="text-decoration-none text-body-secondary">\n                        <img class="col-auto rounded-circle"\n                             style="border:2px solid rgba(71,71,71,1);width:2.3rem;"\n                             src="${e.author_avatar}">\n                    </a>\n                    <div class="p-2 fs-6">\n                        <div class="text-start">\n                        <a href="?thread=${e.id}" class="text-decoration-none text-body-secondary">\n                                <span class="mb-0">${e.topic} ${1==e.pinned?"<i class='bi bi-pin-angle-fill'></i>":""} ${1==e.locked?"<i class='bi bi-lock-fill'></i>":""}</span>\n                            </div>\n                            <div class="text-start">\n                                <span style="color:#178649ff;">${e.created} • </span>\n                                <span style="color:#178649ff;">${e.replies} ${r(parseInt(e.replies),"ответ","ответа","ответов")}</span>\n                            </div>\n                        </a>\n                    </div>\n                </div>\n                <hr>\n            `;if(n.pages>1){i.classList.remove("d-none"),i.innerHTML="",n.page>4&&(i.innerHTML+=`<li class='page-item'>\n                    <a class='page-link text-black shadow-none' onclick="get_threads('${t}', 1)">\n                        <span aria-hidden='true'>&laquo;</span>\n                    </a>\n                </li>`),i.innerHTML+=`<li class='page-item ${1==n.page?"disabled":""}'>\n                <a class='page-link text-black shadow-none' onclick="get_threads('${t}', ${n.prev})">Prev</a>\n            </li>`;for(let e=1;e<=n.pages;e++)e>=n.page-3&&e<=n.page+3&&(i.innerHTML+=`<li class='page-item ${n.page==e?"active":""}'>\n                        <a class='page-link text-black shadow-none' onclick="get_threads('${t}', ${e})">${e}</a>\n                    </li>`);i.innerHTML+=`<li class='page-item ${n.page==n.pages?"disabled":""}'>\n                <a class='page-link text-black shadow-none' onclick="get_threads('${t}', ${n.next})">Next</a>\n            </li>`,n.page<n.pages-2&&(i.innerHTML+=`<li class='page-item'>\n                    <a class='page-link text-black shadow-none' onclick="get_threads('${t}', ${n.pages})">\n                        <span aria-hidden='true'>&raquo;</span>\n                    </a>\n                </li>`)}}catch(e){alert(e)}};const s=[...document.querySelectorAll('[id^="threadList-"]')];!async function(){for(const e of s){const t=e.id.replace("threadList-","");await get_threads(t)}}()}));