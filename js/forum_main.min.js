document.addEventListener("DOMContentLoaded",(function(){async function e(e){try{const t=await fetch("core/api.php",{method:"POST",body:e}),n=await t.text();try{return JSON.parse(n)}catch(e){throw new Error("Invalid JSON response: "+n)}}catch(e){throw e}}window.quill=new Quill("#editor",{theme:"snow",modules:{syntax:!0,toolbar:{container:[[{header:[1,2,3,!1]}],["blockquote","link"],["bold","italic","underline","strike"],["image","video","code-block"],[{list:"ordered"},{list:"bullet"},{font:[]}],[{align:[]},{color:[]}]],handlers:{image:function(){const e=this.quill.getSelection(),t=prompt("Введите ссылку на картинку.");t&&""!=t&&this.quill.insertEmbed(e?e.index:0,"image",t,Quill.sources.USER)}}}}});const t={};var n;const a=document.querySelectorAll(".collapse");a.forEach((e=>{e.addEventListener("show.bs.collapse",(function(){if(e.id.startsWith("threadCollapse-")){const a=e.id.replace("threadCollapse-","");u(a,t[a]);const o=function(){n==a&&history.replaceState(null,"",window.location.pathname),e.removeEventListener("hide.bs.collapse",o)};e.addEventListener("hide.bs.collapse",o),n=a}a.forEach((t=>{if(t!==e&&t.classList.contains("show")){const e=bootstrap.Collapse.getInstance(t);e?e.hide():new bootstrap.Collapse(t,{toggle:!1}).hide()}}))}))}));const o=document.getElementById("action"),i=document.getElementById("icon"),d=document.getElementById("cat_fsub"),l=document.getElementById("createBtn");function c(){const e=o&&"new_subcat"===o.value;i&&(i.style.display=e?"":"none"),d&&(d.style.display=e?"":"none")}o&&(o.addEventListener("change",c),c()),document.querySelectorAll("[id^='lock_subcat']").forEach((t=>{t.addEventListener("click",(async n=>{const a=t.id.split("-")[1],o=new FormData;o.append("forum_admin","lock_subcat"),o.append("id",a);try{const t=await e(o);t.error?alert(t.error):location.reload()}catch(e){alert("Ошибка: "+e.message)}}))})),l&&l.addEventListener("click",(async()=>{const t=o?o.value:"new_cat",n=document.getElementById("name").value.trim(),a=document.getElementById("prior").value.trim(),l=i?i.value.trim():"",c=d?d.value:"",s=new FormData;s.append("forum_admin",t),s.append("name",n),s.append("prior",a),"new_subcat"===t&&(s.append("icon",l),s.append("cat_id",c));try{const t=await e(s);t.error?alert(t.error):location.reload()}catch(e){alert("Ошибка: "+e.message)}})),document.querySelectorAll(".edit-btn").forEach((t=>{t.addEventListener("click",(async n=>{const a=t.id.split("-")[1],o=document.getElementById("action_edit-"+a),i=document.getElementById("cat_id-"+a),d=document.getElementById("edit_name-"+a),l=document.getElementById("edit_prior-"+a),c=document.getElementById("edit_icon-"+a),s=o?o.value:"edit_cat",r=new FormData;"edit_cat"===s?(r.append("forum_admin","edit_cat"),r.append("id",a),r.append("name",d.value.trim()),r.append("prior",l.value.trim())):(r.append("forum_admin","edit_subcat"),r.append("id",i?i.value:""),r.append("name",d.value.trim()),r.append("prior",l.value.trim()),r.append("cat_id",a),r.append("icon",c?c.value.trim():""));try{const t=await e(r);t.error?alert(t.error):location.reload()}catch(e){alert("Сетевая ошибка: "+e.message)}}))})),document.querySelectorAll(".edit-action").forEach((e=>{const t=e.id.split("-")[1],n=document.getElementById("cat_id-"+t),a=document.getElementById("edit_name-"+t),o=document.getElementById("edit_prior-"+t),i=document.getElementById("edit_icon-"+t);function d(){if(!e)return;const t="edit_subcat"===e.value;i&&(i.style.display=t?"":"none"),n&&(n.style.display=t?"":"none"),t&&n&&(a.value=n.options[n.selectedIndex].text,o.value=n.options[n.selectedIndex].dataset.prior||"",i.value=n.options[n.selectedIndex].dataset.icon||"")}e.addEventListener("change",d),d(),n&&n.addEventListener("change",(()=>{a&&o&&i&&(a.value=n.options[n.selectedIndex].text,o.value=n.options[n.selectedIndex].dataset.prior||"",i.value=n.options[n.selectedIndex].dataset.icon||"")}))})),document.querySelectorAll(".rm-btn").forEach((t=>{t.addEventListener("click",(async()=>{const n=t.id.split("-")[1],a=document.getElementById("action_edit-"+n),o=document.getElementById("cat_id-"+n),i=a?a.value:"edit_cat";if(!confirm("Удалить выбранный элемент?"))return;const d=new FormData;"edit_cat"===i?(d.append("forum_admin","delete_cat"),d.append("id",n)):(d.append("forum_admin","delete_subcat"),d.append("id",o?o.value:""));try{const t=await e(d);t.error?alert(t.error):location.reload()}catch(e){alert("Ошибка: "+e.message)}}))}));let s=null;document.querySelectorAll(".newpost-btn").forEach((e=>{e.addEventListener("click",(()=>{s=e.id.split("-")[1];const t=e.dataset.name||e.closest('[id^="subcat-"]')?.querySelector(".subcat-name")?.textContent||"подкатегории";document.getElementById("modallbl").innerText="Новый тред в «"+t+"»";document.getElementById("iinpttl").value="",window.quill&&(window.quill.root.innerHTML="")}))}));const r=document.getElementById("publish");function p(e,t,n,a){const o=(e=Math.abs(e)%100)%10;return e>10&&e<20?a:o>1&&o<5?n:1==o?t:a}function u(e,t){const n=new URLSearchParams(window.location.search);n.set("scid",e),t&&t>1?n.set("scpg",t):n.delete("scpg"),history.replaceState(null,"",`?${n.toString()}`)}r&&r.addEventListener("click",(async()=>{if(!s)return void alert("Не выбрана подкатегория");const t=document.getElementById("iinpttl").value.trim(),n=quill.getContents(),a=JSON.stringify(n),o=new FormData;o.append("forum","new_thread"),o.append("subcat_id",s),o.append("topic",t),o.append("content",a);try{const t=await e(o);t.error?alert(t.error||"Ошибка при создании треда."):location.reload()}catch(e){alert("Сетевая ошибка: "+e.message)}})),window.get_threads=async function(n,a=1,o){const i=document.getElementById("threadList-"+n),d=document.getElementById("threadPag-"+n);if(!i||!d)return;const l=new FormData;l.append("forum","get_threads"),l.append("subcat_id",n),l.append("page",a),o||u(n,a);try{const a=await e(l);if(a.error)return void alert(a.error);if(i.innerHTML="",a.data.length>0){let e='<div class="card">';for(let t=0;t<a.data.length;t++){const n=a.data[t];e+=`\n                    <a href="?thread=${n.id}" class="btn btn-light d-flex align-items-center text-decoration-none text-body-secondary rounded-0 ${0==t?"rounded-top-1":""} ${t==a.data.length-1?"rounded-bottom-1":""}">\n                            <img class="col-auto rounded-circle"\n                                 style="border:2px solid rgba(71,71,71,1);width:2.3rem;"\n                                 src="${n.author_avatar}">\n                        <div class="p-2 fs-6">\n                            <div class="text-start">\n                                <div class="text-decoration-none text-body-secondary">\n                                    <span class="mb-0">${n.topic} ${1==n.pinned?"<i class='bi bi-pin-angle-fill'></i>":""} ${1==n.locked?"<i class='bi bi-lock-fill'></i>":""}</span>\n                                </div>\n                            </div>\n                            \n                            <div class="text-start">\n                                <span style="color:#178649ff;">${n.created}</span>\n                            </div>\n                        </div>\n                        <div class="text-end d-grid border-start ps-3" style="margin-left:auto;">\n                            <span class="fs-4" style="margin:auto;">${n.replies}</span>\n                            <span>${p(parseInt(n.replies),"пост","поста","постов")}</span>\n                        </div>\n                    </a>\n                    ${t<a.data.length-1?"<hr class='m-0'>":""}\n                `}e+="</div>",i.innerHTML+=e}if(a.pages>1){d.classList.remove("d-none"),d.innerHTML="",t[n]=a.page,a.page>4&&(d.innerHTML+=`<li class='page-item'>\n                    <a class='page-link text-black shadow-none' onclick="get_threads('${n}', 1)">\n                        <span aria-hidden='true'>&laquo;</span>\n                    </a>\n                </li>`),d.innerHTML+=`<li class='page-item ${1==a.page?"disabled":""}'>\n                <a class='page-link text-black shadow-none' onclick="get_threads('${n}', ${a.prev})">Prev</a>\n            </li>`;for(let e=1;e<=a.pages;e++)e>=a.page-3&&e<=a.page+3&&(d.innerHTML+=`<li class='page-item ${a.page==e?"active":""}'>\n                        <a class='page-link text-black shadow-none' onclick="get_threads('${n}', ${e})">${e}</a>\n                    </li>`);d.innerHTML+=`<li class='page-item ${a.page==a.pages?"disabled":""}'>\n                <a class='page-link text-black shadow-none' onclick="get_threads('${n}', ${a.next})">Next</a>\n            </li>`,a.page<a.pages-2&&(d.innerHTML+=`<li class='page-item'>\n                    <a class='page-link text-black shadow-none' onclick="get_threads('${n}', ${a.pages})">\n                        <span aria-hidden='true'>&raquo;</span>\n                    </a>\n                </li>`)}}catch(e){console.log(e)}};const m=[...document.querySelectorAll('[id^="threadList-"]')];(async function(){for(const e of m){const t=e.id.replace("threadList-","");await get_threads(t,1,!0)}})().then((()=>{const e=new URLSearchParams(window.location.search),t=parseInt(e.get("scid")),n=parseInt(e.get("scpg"));if(t){const e=document.querySelector(`[href="#threadCollapse-${t}"]`);e&&(e.click(),n&&get_threads(t,n))}}))}));