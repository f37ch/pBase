document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("editor");e&&(window.quill=new Quill(e,{theme:"snow",modules:{syntax:!0,toolbar:{container:[[{header:[1,2,3,!1]}],["blockquote","link"],["bold","italic","underline","strike"],["image","video","code-block"],[{list:"ordered"},{list:"bullet"},{font:[]}],[{align:[]},{color:[]}]],handlers:{image:function(){const e=this.quill.getSelection(),t=prompt("Введите ссылку на картинку.");t&&""!=t&&this.quill.insertEmbed(e?e.index:0,"image",t,Quill.sources.USER)}}}}})),document.querySelectorAll(".post-content").forEach((function(e){const t=JSON.parse(e.dataset.delta);new Quill(e,{readOnly:!0,theme:"snow",modules:{toolbar:!1,syntax:!0}}).setContents(t)}));const t=document.getElementById("clear");t&&t.addEventListener("click",(()=>{window.quill.setContents(),window.editingPostId=null,t.innerText="Очистить поле",n.innerText="Ответить"}));const n=document.getElementById("publish");n&&n.addEventListener("click",(()=>{const e=JSON.stringify(window.quill.getContents()),t=new URLSearchParams(window.location.search).get("thread"),o=n.dataset.counter;let i;i=window.editingPostId?new URLSearchParams({forum:"edit_post",post_id:window.editingPostId,content:e}):new URLSearchParams({forum:"new_post",thread_id:t,content:e}),fetch("core/api.php",{method:"POST",body:i}).then((e=>e.json())).then((e=>{if(window.editingPostId=null,n.innerText="Ответить",e.success)if(8==o){const e=new URL(window.location.href),t=e.searchParams;let n=parseInt(t.get("pg")||"1",10);n=isNaN(n)?1:n,t.set("pg",n+1),e.search=t.toString(),window.location.href=e.toString()}else location.reload();else alert(e.error||"Ошибка при публикации")})).catch((e=>{window.editingPostId=null,alert("Не удалось отправить пост")}))})),document.querySelectorAll(".thread-btn").forEach((function(e){e.addEventListener("click",(function(){const e=this.dataset.id,o=this.dataset.action;if(e&&o){if("edit_post"===o){const o=document.querySelector(`#post-${e} .post-content`);if(!o)return void alert("Не удалось найти содержимое поста");const i=JSON.parse(o.dataset.delta);return window.quill.setContents(i),window.editingPostId=e,document.querySelector("#editor").scrollIntoView({behavior:"smooth"}),n.innerText="Сохранить",void(t.innerText="Отменить редактирование")}("delete_post"!==o||confirm("Удалить пост?"))&&("delete_thread"!==o||confirm("Удалить весь тред?"))&&fetch("core/api.php",{method:"POST",body:new URLSearchParams({forum_admin:o,id:e})}).then((e=>e.json())).then((e=>{e.success?"delete_post"===o?window.location.reload():"delete_thread"===o?window.location.href="/forum.php":("pin_thread"===o||"lock_thread"===o)&&window.location.reload():alert("Ошибка: "+(e.error||"Неизвестная ошибка"))})).catch((e=>{alert("Ошибка запроса")}))}}))})),document.querySelectorAll(".reactions .reaction").forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.pid,t=this.dataset.type;fetch("core/api.php",{method:"POST",body:new URLSearchParams({forum:"reaction",post_id:e,type:t})}).then((e=>e.json())).then((e=>{if(e.success){const t=this.querySelector(".count"),n=e.count||0;e.added?this.classList.add("reacted"):e.removed&&this.classList.remove("reacted"),n>0?(t.style.display="inline",t.textContent=n):t.style.display="none"}else alert(e.error||"Ошибка реакции")})).catch((()=>alert("Ошибка запроса реакции")))}))}))}));