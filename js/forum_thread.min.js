document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("editor");e&&(window.quill=new Quill(e,{theme:"snow",modules:{syntax:!0,toolbar:{container:[[{header:[1,2,!1]}],["blockquote","link"],["bold","italic","underline","strike",{align:[]},{color:[]}],["image","video","code-block"],[{list:"ordered"},{list:"bullet"},{font:[]}]],handlers:{image:function(){const e=this.quill.getSelection(),t=prompt("Введите ссылку на картинку.");t&&""!=t&&this.quill.insertEmbed(e?e.index:0,"image",t,Quill.sources.USER)}}}}})),document.querySelectorAll(".post-content").forEach((function(e){const t=JSON.parse(e.dataset.delta);new Quill(e,{readOnly:!0,theme:"snow",modules:{toolbar:!1,syntax:!0}}).setContents(t)}));const t=document.getElementById("clear");t&&t.addEventListener("click",(()=>{window.quill.setContents(),window.editingPostId=null,window.replyPostId=null,t.innerText="Очистить поле",o.innerText="Ответить"}));const o=document.getElementById("publish");o&&o.addEventListener("click",(()=>{const e=JSON.stringify(window.quill.getContents()),n=new URLSearchParams(window.location.search).get("thread"),i=o.dataset.counter;let d;d=window.editingPostId?new URLSearchParams({forum:"edit_post",post_id:window.editingPostId,content:e}):window.replyPostId?new URLSearchParams({forum:"new_post",thread_id:n,reply_id:window.replyPostId,content:e}):new URLSearchParams({forum:"new_post",thread_id:n,content:e}),fetch("core/api.php",{method:"POST",body:d}).then((e=>e.json())).then((e=>{if(e.success)if(8!=i||window.editingPostId)location.reload();else{const t=8,o=Math.ceil(e.thread.total_posts/t),n=new URL(window.location.href);n.searchParams.set("pg",o),n.hash="post-"+e.thread.last_post_id,window.location.href=n.toString()}else alert(e.error||"Ошибка при публикации");window.editingPostId=null,window.replyPostId=null,o.innerText="Ответить",t.innerText="Очистить поле"})).catch((e=>{window.editingPostId=null,window.replyPostId=null,o.innerText="Ответить",t.innerText="Очистить поле",alert("Не удалось отправить пост")}))})),document.querySelectorAll(".thread-btn").forEach((function(e){e.addEventListener("click",(function(){const e=this.dataset.id,n=this.dataset.action;if(e&&n){if("edit_post"===n){const n=document.querySelector(`#post-${e} .post-content`);if(!n)return void alert("Не удалось найти содержимое поста");const i=JSON.parse(n.dataset.delta);return window.quill.setContents(i),window.editingPostId=e,document.querySelector("#editor").scrollIntoView({behavior:"smooth"}),o.innerText="Сохранить",void(t.innerText="Отменить редактирование")}if("reply_post"===n){return document.querySelector(`#post-${e} .post-content`)?(window.replyPostId=e,document.querySelector("#editor").scrollIntoView({behavior:"smooth"}),o.innerText="Ответить на пост "+this.dataset.vicnt,void(t.innerText="Отменить ответ")):void alert("Не удалось найти содержимое поста")}("delete_post"!==n||confirm("Удалить пост?"))&&("delete_thread"!==n||confirm("Удалить весь тред?"))&&fetch("core/api.php",{method:"POST",body:new URLSearchParams({forum_admin:n,id:e})}).then((e=>e.json())).then((e=>{e.success?"delete_post"===n?window.location.reload():"delete_thread"===n?window.location.href="/forum.php":("pin_thread"===n||"lock_thread"===n)&&window.location.reload():alert("Ошибка: "+(e.error||"Неизвестная ошибка"))})).catch((e=>{alert("Ошибка запроса")}))}}))})),document.querySelectorAll(".reactions .reaction").forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.pid,t=this.dataset.type;fetch("core/api.php",{method:"POST",body:new URLSearchParams({forum:"reaction",post_id:e,type:t})}).then((e=>e.json())).then((e=>{if(e.success){const t=this.querySelector(".count"),o=e.count||0;e.added?this.classList.add("reacted"):e.removed&&this.classList.remove("reacted"),o>0?(t.style.display="inline",t.textContent=o):t.style.display="none"}else alert(e.error||"Ошибка реакции")})).catch((()=>alert("Ошибка запроса реакции")))}))}))}));